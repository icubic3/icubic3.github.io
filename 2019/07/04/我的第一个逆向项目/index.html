<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="难得的第一篇博客，就来写最近第一次逆向iOS app的经历吧。背景是，之前一直用的某个游戏加速器最近突然改成收费了，可是可以通过看广告来赚取积分换时间，于是想着能不能通过逆向的方式来跳过广告。就最终结果而言，并没有达到当时预想要的功能。但是其中学习到了逆向中的一些思路还有工具的使用啥的，确实还是很需">
    

    <!--Author-->
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="我的第一个逆向项目">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="i3 Studio">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>我的第一个逆向项目 - i3 Studio</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about/index.html">
                    About
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/07/04/我的第一个逆向项目/">
                我的第一个逆向项目
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-04</span>
            
            
            
                <span class="category">
                    <a href="/categories/iOS/">iOS</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>难得的第一篇博客，就来写最近第一次逆向iOS app的经历吧。<br>背景是，之前一直用的某个游戏加速器最近突然改成收费了，可是可以通过看广告来赚取积分换时间，于是想着能不能通过逆向的方式来跳过广告。<br>就最终结果而言，并没有达到当时预想要的功能。但是其中学习到了逆向中的一些思路还有工具的使用啥的，确实还是很需要记录一下的，而且后面如果要继续把这个想法做下去的话也可以沿着这个做。</p>
<h1 id="工具篇"><a href="#工具篇" class="headerlink" title="工具篇"></a>工具篇</h1><p>使用的工具基本是参考了《iOS应用逆向与安全》一书。</p>
<h2 id="越狱设备"><a href="#越狱设备" class="headerlink" title="越狱设备"></a>越狱设备</h2><p>越狱的话，最好还是先可以准备一台越狱设备。我使用的设备是iOS10.3.3的iPad，用的是H3lix越狱。具体在机子上需要安装什么要视情况而定。我个人觉得比较有必要的包如下：</p>
<ul>
<li>Dropbear：开启SSH服务，如果其他越狱方式自带有SSH的就可以不用装。</li>
<li>APPSync：允许设备绕过运行APP的签名验证</li>
<li>AFC2：允许iTools等工具访问到越狱后的系统</li>
<li>iFile：允许直接在设备上直接对越狱后的系统中的文件进行操作</li>
<li>Cydia Substrate：越狱开发的框架</li>
<li>adv-cmds：命令行软件包，提供比如ps等命令</li>
<li>Cycript：允许使用Cycript来调试运行中的app</li>
<li>Reveal2Loader：允许直接以开关的形式选择Reveal要调试的设备上的app，而不用去写plist文件了</li>
<li>MTerminal：设备上的终端，就在无法用SSH连上设备的时候用一下，开了SSH之后还是直接通过电脑来敲命令更舒服一些</li>
<li>Stream/Thor：抓包软件，通过APP Store下载。用起来比Charles啥的舒服，一般的抓包分析也够用了。</li>
</ul>
<h2 id="电脑上的工具"><a href="#电脑上的工具" class="headerlink" title="电脑上的工具"></a>电脑上的工具</h2><p>电脑上也需要准备一定的工具。我看的书里面有一部分是为了介绍原理所以有些地方绕了圈子，事实上很多可以通过工具来简化步骤。</p>
<ul>
<li>dumpdecrypted/Clutch：砸壳工具。后者使用简单，而且导出的是ipa格式，相对舒服一些。前者可以砸一些后者解决不了的app，导出Mach-O文件。</li>
<li>class-dump：提取头文件的工具。通过提取出来的头文件，可以弄明白app使用的架构，使用了什么第三方框架，数据结构是怎样的等等。</li>
<li>Reveal：查看App视图，并且可以通过视图看到对应的类名，可以节省很多时间。</li>
<li>iTools Pro：设备文件管理工具，可视化操作用起来比scp舒服。替代品是iFunbox等。</li>
<li>MonkeyDev：AloneMonkey大佬的越狱开发工具包，包含了越狱开发中的常用工具（class-dump啥的里面都有），支持Logos和CaptainHook等，具体使用参考其<a href="https://github.com/AloneMonkey/MonkeyDev/wiki" target="_blank" rel="noopener">wiki</a></li>
<li>ida/Hooper：反汇编工具，用来分析Mach-O文件，我用着ida比较习惯，提供了生成伪码的功能。根据伪码可以了解到app中某个方法的具体实现是怎样的。</li>
</ul>
<p>主要的工具也就这些吧，整个分析的过程里用的最多的就是上面这几个工具。具体的使用方式就略过了，然后记录下遇到的坑和一些使用的心得，防止后面忘了。</p>
<h1 id="砸壳篇"><a href="#砸壳篇" class="headerlink" title="砸壳篇"></a>砸壳篇</h1><p>因为这次要逆向的东西常见的App市场上没有（其实一般也都没有的吧…），所以需要自己砸壳。</p>
<h2 id="dumpdecrypted"><a href="#dumpdecrypted" class="headerlink" title="dumpdecrypted"></a>dumpdecrypted</h2><p>这次砸壳用的dumpdecrypted（Clutch后面也用了下，整个过程比较简单，也没遇到啥问题，后面再说）。简单的使用过程如下：<br>1、先clone并且编译了dumpdecrypted，会得到一个dumpdecrypted.dylib<br>2、获得要砸壳的app可执行文件位置。运行目标app，然后命令行通过<br><code>ps -e</code><br>可以查看正在运行的进程，便可以找到该app进程的PID和路径等信息了<br>3、获得可执行文件的路径之后就可以通过打开.app文件，来查看其info.plist，获得Bundle ID<br>4、获得目标app的沙盒路径。这个如果有iTools之类的话，可以直接打开到app对应的沙盒目录。找到沙盒目录之后把上面生成的dylib复制到Documents文件夹下。<br>5、最关键的，砸壳。通过运行这个命令就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/mobile/Containers/Data/Application/1C48472D-DDB6-4908-87D6-C19258505E2A/Documents </span><br><span class="line">DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/containers/Bundle/Application/A9E4B6AD-0DD1-46F7-A57F-CFB9B8F55EAF/目标加速器.app/目标加速器</span><br></pre></td></tr></table></figure>

<p>其实就是cd到之前动态库所在的目录下，执行<code>DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib</code><br>然后参数部分是可执行文件的位置就行了。这里遇到2个坑，一个是执行的时候我提示了一个错误：<br>dumpdecrypted.dylib: required code signature missing for ‘dumpdecrypted.dylib’<br>这个是动态库缺少了签名导致的，对这个dylib执行这个命令，使用ldid来签名就行了：<br><code>ldid -S dumpdecrypted.dylib</code><br>另外一个是我要砸壳的app是带有中文名的，而我的终端对中文名支持有很大问题…找了一圈结果也没啥好的解决方法，最后还是写了个shell脚本然后扔到设备里，跑一下就行了。<br>完成之后会生成一个“目标加速器.decrypted”文件，这个就是我们想要的东西了，把这个直接拷回来就行。<br>6、验证解密结果。用这个命令就能对解密的结果进行查看：<br><code>otool -l 目标加速器.decrypted | grep crypt</code><br>输出的应该是类似这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> cryptoff 16384</span><br><span class="line">cryptsize 10518528</span><br><span class="line">  cryptid 0</span><br></pre></td></tr></table></figure>

<p>有的app会有几个这样的部分，分别对应不同架构下的。cryptid为0的说明解密成功，为1的说明还是加密状态，不过只要把我们想要的那个解密成功的架构类型拿出来就行了。命令为：<br><code>lipo TargetApp.decrypted -thin arm64 -output TargetApp.arm64</code></p>
<h2 id="Clutch"><a href="#Clutch" class="headerlink" title="Clutch"></a>Clutch</h2><p>后面也顺带试了下Clutch，整个使用就3步<br>1、下载编译，然后把编译出来的可执行文件放到设备的/usr/bin目录下，并且加可执行权限<br><code>chmod +x usr/bin/Clutch</code><br>2、<code>Clutch -i</code>，获取可以解密的应用<br>3、<code>Clutch -d 序号</code>，就可以砸壳了<br>完了之后直接可以得到砸壳后的ipa。</p>
<h1 id="提取头文件"><a href="#提取头文件" class="headerlink" title="提取头文件"></a>提取头文件</h1><p>通过class-dump可以直接获取可执行文件的头文件。<br>先clone完了编译一遍，可以得到一个可执行文件<br>然后通过<br><code>./class-dump --arch arm64 目标加速器 -H -o ./Headers</code><br>可以把头文件给生成到Headers文件夹中，之后直接就可以分析了。<br>这样生成的头文件中，遇到Block类型的话，会默认CDUnknownBlockType来表示。处理方式放在后面一起说。</p>
<h1 id="分析实现"><a href="#分析实现" class="headerlink" title="分析实现"></a>分析实现</h1><p>就不具体的划分静态分析和动态分析了，结合起来分析效率最高。而且分析的思路很重要。<br>这次分析这个加速器，主要是广告的页面。为了防止被发现是哪个加速器，就不截图了…<br>先通过Reveal，获取目标所在的VC。我要逆向的是一个页面中的banner，在Reveal中发现该banner在WKWebView里..<br>既然是webView,那交互肯定是通过bridge的。并且该vc中肯定有处理那些事件的方法。于是直接找到那个VC，头文件里倒是很简单，大概长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;BaseWebViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ActivityCenterViewController : BaseWebViewController</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)handleMessageName:(id)arg1 body:(id)arg2;</span><br><span class="line">- (void)initData;</span><br><span class="line">- (void)viewDidLoad;</span><br><span class="line">- (id)init;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>那很好说，既然特地写了个子类，那该页面的事件处理应该也在这个子类里，父类负责注册bridge事件。除了生命周期方法，只剩下这个方法有价值：<br><code>- (void)handleMessageName:(id)arg1 body:(id)arg2;</code><br>通过ida可以分析，这个确实是处理该页面点击的方法。MessageName和body传入事件名和参数，然后在里面判断再调用别的东西。在该方法的实现里有一段代码估计就是我想要的了。这是那段代码的伪代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if ( (unsigned int)objc_msgSend(v6, &quot;isEqualToString:&quot;, CFSTR(&quot;watchAdvert&quot;)) )</span><br><span class="line">&#123;</span><br><span class="line">  objc_initWeak(&amp;v29, v5);</span><br><span class="line">  v24 = _NSConcreteStackBlock;</span><br><span class="line">  v25 = 3254779904LL;</span><br><span class="line">  v26 = sub_100083BE0;</span><br><span class="line">  v27 = &amp;unk_100A0FC50;</span><br><span class="line">  objc_copyWeak(&amp;v28, &amp;v29);</span><br><span class="line">  +[AdvsManager showRewardAdvCallBack:](&amp;OBJC_CLASS___AdvsManager, &quot;showRewardAdvCallBack:&quot;, &amp;v24);</span><br><span class="line">  objc_destroyWeak(&amp;v28);</span><br><span class="line">  objc_destroyWeak(&amp;v29);</span><br><span class="line">  goto LABEL_13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当MessageName为watchAdvert，则就会调用AdvsManager类的类方法showRewardAdvCallBack，并且传入一个block。从方法名可以猜得出这就是开启广告的方法，接下来就是进行断点调试了。下面这部分主要讲一下动态调试的部分技巧</p>
<h2 id="动态调试相关"><a href="#动态调试相关" class="headerlink" title="动态调试相关"></a>动态调试相关</h2><p>通过debugserver和lldb可以直接对越狱设备中的app进行断点调试，但是因为还需要还原符号表和计算偏移值等步骤，这方法下断点会比较麻烦。利用MonkeyDev则可以大大简化这个步骤。<br>在安装完MonkeyDev之后，新建一个MonkeyApp，把.app文件拖入到对应的地方，就可以跑起来了。<br>直接在Logos文件夹下的.xm文件编写Logos语句，对原本app的方法hook，就可以直接进行断点调试，这就很方便了。<br>Logos语法很简单，基本就是在OC基础上加上几个新的符号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">%hook ClassName</span><br><span class="line">/**</span><br><span class="line">  通过这个来hook某个类</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">// hook实例方法</span><br><span class="line">- (void)instanceMethod:(id)param&#123;</span><br><span class="line">    %orig(param); //原本实现,带参数</span><br><span class="line">    [%c(ClassName) classMethod:param];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// hook类方法</span><br><span class="line">+ (void)classMethod:(id)param&#123;</span><br><span class="line">    %orig; //原本实现，按原参数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>基本的用法就是这样，还有一些要注意的：<br>调用某个类的实例方法，可以在前面声明一遍同名类和同名方法，然后后面调用就行，会调用到原本的实现。<br>新增方法的话需要%new()来标记方法。其他的可以参照Logos的语法。</p>
<hr>
<p>上面说到showRewardAdvCallBack这个方法很有可能就是想要的方法，于是先hook它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (void)showRewardAdvCallBack:(CDUnknownBlockType)arg1;</span><br></pre></td></tr></table></figure>

<p> 通过MonkeyApp进行hook之后，就可以对其下断点了。可是这玩意的参数却是一个CDUnknownBlockType，也就是一个block。遇到这种情况，我们需要先知道这个block的参数和返回值是啥样子的。在理解了block的内存结构，利用lldb，也是可以获取到的，具体可以<a href="http://bbs.iosre.com/t/block/6779" target="_blank" rel="noopener">看这个</a>。如果是使用MonkeyApp的话，本身把这个过程放到了LLDBTools.mm中，直接调用po pblock(address)就可以打印出block的结构了。<br>打印出来发现这个callBack长这样：<br><code>(void (^)(bool ,bool ,NSString * ,NSString * ,NSString * ,NSString *))arg1</code><br>知道这个block之后，也可以对这个block的实现进行替换。参考了SMSNinja源码的写法，类似这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (void)showRewardAdvCallBack:(void (^)(bool ,bool ,NSString * ,NSString * ,NSString * ,NSString *))arg1&#123;</span><br><span class="line">    void (^myBlock)(bool ,bool ,NSString * ,NSString * ,NSString * ,NSString *) = ^(bool a1,bool a2,NSString * s1,NSString * s2,NSString * s3,NSString *s4) &#123;</span><br><span class="line">        // hook here</span><br><span class="line">    &#125;;</span><br><span class="line">    %orig(myBlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里hook这个block主要是为了验证后面回调的时候一些参数是否正确，然后继续往下看AdvsManager，这个类里面方法特别多，主要是要看看在showRewardAdvCallBack这个方法里到底是通过调用了什么来弹出广告。伪代码中发现了这一段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v51 = (void *)objc_retainAutoreleasedReturnValue(v50);</span><br><span class="line">      if ( (unsigned __int64)objc_msgSend(v51, &quot;isEqualToString:&quot;, CFSTR(&quot;csj&quot;)) &amp; 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v52 = 0;</span><br><span class="line">      &#125;</span><br><span class="line">      else if ( (unsigned __int64)objc_msgSend(v51, &quot;isEqualToString:&quot;, CFSTR(&quot;unity&quot;)) &amp; 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        v52 = 2;</span><br><span class="line">      &#125;</span><br><span class="line">      else if ( (unsigned int)objc_msgSend(v51, &quot;isEqualToString:&quot;, CFSTR(&quot;mintegral&quot;)) )</span><br><span class="line">      &#123;</span><br><span class="line">        v52 = 1;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        v52 = 2;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>以及这一段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> if ( (v52 &amp; 3) == 2 )</span><br><span class="line">      &#123;</span><br><span class="line">        objc_msgSend(v6, &quot;showUnityRewardAdv&quot;);</span><br><span class="line">        v55 = CFSTR(&quot;unity&quot;);</span><br><span class="line">        objc_retain(CFSTR(&quot;unity&quot;), v61);</span><br><span class="line">        objc_release(&amp;stru_100A335C0);</span><br><span class="line">        objc_retain(CFSTR(&quot;unity&quot;), v62);</span><br><span class="line">        objc_release(&amp;stru_100A335C0);</span><br><span class="line">        v58 = CFSTR(&quot;unity&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        if ( (v52 &amp; 3) == 1 )</span><br><span class="line">        &#123;</span><br><span class="line">          objc_msgSend(v6, &quot;showMintegralRewardAdvWithPlaceID:&quot;, v54);</span><br><span class="line">          v55 = CFSTR(&quot;Mintagral&quot;);</span><br><span class="line">          objc_retain(CFSTR(&quot;Mintagral&quot;), v63);</span><br><span class="line">          objc_release(&amp;stru_100A335C0);</span><br><span class="line">          v58 = CFSTR(&quot;mintegral&quot;);</span><br><span class="line">          goto LABEL_31;</span><br><span class="line">        &#125;</span><br><span class="line">        v58 = &amp;stru_100A335C0;</span><br><span class="line">        if ( !(v52 &amp; 3) )</span><br><span class="line">        &#123;</span><br><span class="line">          objc_msgSend(v6, &quot;showBuRewardAdvWithPlaceID:&quot;, v54);</span><br><span class="line">          v55 = CFSTR(&quot;穿山甲&quot;);</span><br><span class="line">          objc_retain(CFSTR(&quot;穿山甲&quot;), v59);</span><br><span class="line">          objc_release(&amp;stru_100A335C0);</span><br><span class="line">          v58 = CFSTR(&quot;csj&quot;);</span><br><span class="line">LABEL_31:</span><br><span class="line">          objc_retain(v58, v60);</span><br><span class="line">          objc_release(&amp;stru_100A335C0);</span><br><span class="line">          goto LABEL_32;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>结合起来可以发现，通过上面的过程，获得到了v51的值，并且判断v51是啥值，来决定调用哪部分的方法。showUnityRewardAdv、showMintegralRewardAdvWithPlaceID以及showBuRewardAdvWithPlaceID这三个方法分别是三个广告渠道商的展示广告的方法，可以看出来这个app接入了Unity，Mintegral和穿山甲这三家的广告，并且让当前的vc成为了这三个广告展示类的delegate，用以接收广告播放结束、中断等事件的回调。<br>那么就得转进广告播放结束的回调了，通过查看该AdvsManager实现的协议，找到了对应的三个代理方法，然后进行hook应该就能解决了。<br>当时觉得这样做未免也太过复杂了…既然设置了callback的block，而且通过抓包发现，这个回调block其实拿到了这些字符串参数之后发送了一次网络请求，表示播放结束了，以此来换取积分。反过来说，我只要知道这些字符串对应的意义，以及获取的方法，直接发给后台，那不就解决了？<br>这个回调的block应该是在某个地方集中处理了字符串然后再调用的（原本觉得是在三个地方的协议方法中调用的，后来没找到），于是后来找到了这么一个方法：<br><code>- (void)rewardVideoClose:(_Bool)arg1 channel:(unsigned long long)arg2;</code><br>通过ida查看这个方法的实现，发现在这个方法里确实拼接了所需要的参数并且调用了回调block，而且其实所需要的参数在播放视频的时候就已经知道了。那事情就简单了，于是写了这么个方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)showUnityRewardAdv&#123;</span><br><span class="line">//    %orig;</span><br><span class="line">    [%c(FLProgressHUD) dismiss];</span><br><span class="line">    [self rewardVideoClose:YES channel:2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)showMintegralRewardAdvWithPlaceID:(id)arg1&#123;</span><br><span class="line">//    %orig;</span><br><span class="line">    [%c(FLProgressHUD) dismiss];</span><br><span class="line">    [self rewardVideoClose:YES channel:1];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)showBuRewardAdvWithPlaceID:(id)arg1&#123;</span><br><span class="line">//    %orig;</span><br><span class="line">    [%c(FLProgressHUD) dismiss];</span><br><span class="line">    [self rewardVideoClose:YES channel:0];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>channel的值在上面已经获取到了，这里照着填进去就行。然后试着跑了一遍，果然提示积分获取成功的Toast！而且也没有弹出任何视频！<br>………………原本以为这样就完工了<br>后来发现，虽然弹出了获取到了积分的提示，也就是网络请求成功了，可是积分并没有增加。<br>那只能说明，这个广告积分的获取，除了这一步的请求，还有另一步在验证广告是否真的播放完毕的。那就只能针对3个广告SDK再进行逆向分析和hook才有办法做到去广告了…到这里已经花了很多时间了，感觉再花时间在这个上面也不值，于是打算就这样打住了。</p>
<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>虽然最后还是没有达到想要的目的，但是这次逆向确实是一次很好的经验，对整个逆向的过程有了一些心得了。其实继续深究进去应该是可以达到最开始的目标的，但是花费的时间太多了，感觉也就不值得了。之后如果有时间的话希望看着这个可以回想起当时的思路，然后看看再弄一遍，到时候说不定就成功了。</p>
<h2 id="文章仅供学习研究"><a href="#文章仅供学习研究" class="headerlink" title="文章仅供学习研究"></a>文章仅供学习研究</h2>
    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/iOS开发/">#iOS开发</a> <a href="/tags/逆向/">#逆向</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    个人记录下开发/学习中的一些小心得。
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/07/04/我的第一个逆向项目/">我的第一个逆向项目</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/iOS/">iOS</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/icubic3">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:icubic@qq.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    有问题、讨论或者有合作欢迎点击上方⤴️邮件icon联系我哈~谢谢^_^
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>